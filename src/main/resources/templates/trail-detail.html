<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${trail.name} + ' | Trail Details'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" th:href="@{/images/icon.png}" type="image/png">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">TrailRank</a>
        <div class="d-flex">
            <a class="btn btn-outline-light me-2" th:href="@{/trails}">
                <i class="fas fa-arrow-left"></i> Back to Trails
            </a>
            <span class="navbar-text text-light me-3" th:if="${username}">
                Welcome, <span th:text="${username}"></span>
            </span>
            <form th:if="${username}" th:action="@{/logout}" method="post">
                <button class="btn btn-outline-light" type="submit">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div th:if="${isAiTrail}"
         id="aiTrailMeta"
         th:data-token="${aiToken}"
         class="alert alert-info d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-2">
            <i class="fas fa-magic"></i>
            <span>This is an AI-generated trail preview. Save it to enable ratings, collections, and sharing.</span>
        </div>
        <div class="d-flex gap-2">
            <button id="saveAiTrailBtn" class="btn btn-primary">
                <i class="fas fa-save"></i> Save to My Trails
            </button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <img th:src="${trail.imageUrl != null && !#strings.isEmpty(trail.imageUrl)} ?
                  ${trail.imageUrl} :
                  @{/images/img.png}"
                 th:alt="${trail.name}"
                 class="img-fluid rounded shadow">
        </div>
        <div class="col-md-8">
            <h1 th:text="${trail.name}"></h1>
            <div class="mb-3">
                <span class="badge bg-primary me-2" th:text="${trail.difficulty}"></span>
                <span class="badge bg-success me-2" th:text="${trail.scenery}"></span>
                <span class="text-muted" th:text="${trail.distance} + ' km'"></span>
            </div>
            <p class="lead"><strong>Location:</strong> <span th:text="${trail.location}"></span></p>
            <p class="lead" th:text="${trail.description}"></p>

            <div class="mt-4" th:if="${!isAiTrail}">
                <h4>Trail Details</h4>
                <ul class="list-unstyled">
                    <li><strong>Location:</strong> <span th:text="${trail.location}"></span></li>
                    <li><strong>Difficulty:</strong> <span th:text="${trail.difficulty}"></span></li>
                    <li><strong>Distance:</strong> <span th:text="${trail.distance} + ' km'"></span></li>
                    <li><strong>Scenery:</strong> <span th:text="${trail.scenery}"></span></li>
                    <li><strong>Average Rating:</strong> <span id="avgRating">-</span>/10</li>
                </ul>
            </div>
            <div class="mt-3" th:if="${isAiTrail}">
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-info-circle"></i> Save this trail to enable collections, ratings, and reviews.
                </div>
            </div>

            <div class="mt-4" th:if="${!isAiTrail}">
                <button th:if="${inCollection}" class="btn btn-secondary" disabled>
                    <i class="fas fa-check"></i> Already in Collection
                </button>
                <button th:unless="${inCollection}" class="btn btn-primary"
                        th:onclick="'addToCollection(' + ${trail.trailId} + ')'">
                    <i class="fas fa-bookmark"></i> Add to Collection
                </button>
            </div>
        </div>
    </div>

    <hr class="my-4" th:if="${!isAiTrail}">

    <div th:if="${!isAiTrail}">
        <!-- Summary-only view when ?view=rating -->
        <div th:if="${param.view != null && param.view[0] == 'rating'}" class="row mt-4">
            <div class="col-12 text-center">
                <h2>Rating Summary</h2>
                <div style="width: 120px; height: 120px; border-radius: 50%; background-color: #f8f9fa; border: 3px solid #4a6bff; display: flex; align-items: center; justify-content: center; margin: 0 auto; margin-top: 20px;">
                    <span id="ratingCircle" style="font-size: 36px; font-weight: bold;">-</span><span style="font-size: 18px; font-weight: bold;">/10</span>
                </div>
                <div style="margin-top: 20px; color: #ffc107; font-size: 24px;">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="far fa-star"></i>
                </div>
                <p class="text-muted mt-3">Based on user reviews</p>
            </div>
        </div>

        <!-- Full rating form + reviews when not in summary view -->
        <div th:unless="${param.view != null && param.view[0] == 'rating'}" class="row mt-4">
            <div class="col-md-6">
                <h4>Rate This Trail</h4>
                <form id="ratingForm" class="border p-3 rounded">
                    <div class="mb-3">
                        <label class="form-label">Your Rating (1â€“10)</label>
                        <select id="score" class="form-select" required>
                            <option value="">Select rating</option>
                            <option th:each="i : ${#numbers.sequence(1, 10)}"
                                    th:value="${i}"
                                    th:text="${i}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Your Review</label>
                        <textarea id="comment" class="form-control" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-star"></i> Submit Rating
                    </button>
                </form>
            </div>
            <div class="col-md-6">
                <h4>User Reviews</h4>
                <div id="ratingList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                    <!-- Ratings will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const trailId = [[${trail.trailId} != null ? trail.trailId : -1]];
    const userId = [[${session.userId} != null ? session.userId : -1]];
    const isAiTrail = [[${isAiTrail} != null ? isAiTrail : false]];

    console.log('Trail ID:', trailId);
    console.log('User ID:', userId);

    function addToCollection(trailId) {
        if (!userId) {
            alert('Please log in to add this trail to your collection.');
            return;
        }

        fetch(`/api/collections/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trail_id: trailId, user_id: userId })
        })
        .then(response => {
            console.log('Add to collection response status:', response.status);
            if (response.ok) {
                location.reload(); // Reload to show "Already in Collection"
            } else {
                throw new Error('Failed to add to collection.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add to collection: ' + error.message);
        });
    }

    function submitRating(e) {
        e.preventDefault();

        const score = document.getElementById('score').value;
        const comment = document.getElementById('comment').value;

        if (!score) {
            alert('Please select a rating');
            return;
        }

        if (!userId) {
            alert('Please log in to rate this trail');
            return;
        }

        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

        console.log('Submitting rating:', {
            userId: userId,
            trailId: trailId,
            score: score,
            comment: comment
        });

        fetch('/api/ratings/rate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: Number(userId),
                trailId: Number(trailId),
                score: parseInt(score, 10),
                comment: comment
            })
        })
        .then(response => {
            console.log('Rating submission response status:', response.status);
            if (response.ok) {
                return response.json().catch(() => ({}));
            } else {
                throw new Error('Failed to submit rating');
            }
        })
        .then(data => {
            console.log('Rating submitted successfully:', data);
            loadRatings();
            e.target.reset();
            alert('Rating submitted successfully!');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to submit rating: ' + error.message);
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
        });
    }

    function loadRatings() {
        console.log('Loading ratings for trail ID:', trailId);

        fetch(`/api/ratings/trail/${trailId}/avg`)
            .then(response => {
                console.log('Average rating response status:', response.status);
                if (!response.ok) {
                    throw new Error('Failed to load average rating');
                }
                return response.json();
            })
            .then(avg => {
                console.log('Average rating:', avg);
                document.getElementById('avgRating').textContent = avg ? avg.toFixed(1) : '-';

                const ratingCircle = document.getElementById('ratingCircle');
                if (ratingCircle) {
                    ratingCircle.textContent = avg ? avg.toFixed(1) : '-';
                }
            })
            .catch(error => {
                console.error('Error loading average rating:', error);
                document.getElementById('avgRating').textContent = '-';
            });

        fetch(`/api/ratings/trail/${trailId}`)
            .then(response => {
                console.log('Rating list response status:', response.status);
                if (!response.ok) {
                    throw new Error('Failed to load rating list');
                }
                return response.json();
            })
            .then(ratings => {
                console.log('Ratings received:', ratings);
                const container = document.getElementById('ratingList');
                if (!container) {
                    return;
                }

                container.innerHTML = '';

                if (!ratings || ratings.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No reviews yet</div>';
                    return;
                }

                ratings.slice().reverse().forEach(rating => {
                    const ratingElement = document.createElement('div');
                    ratingElement.className = 'list-group-item';
                    ratingElement.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${rating.username || 'User ' + rating.userId}</h6>
                            <small class="text-muted">${rating.createDate ? new Date(rating.createDate).toLocaleDateString() : ''}</small>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-warning text-dark">${rating.score}/10</span>
                        </div>
                        <p class="mb-1">${rating.comment || 'No comment content'}</p>
                    `;
                    container.appendChild(ratingElement);
                });
            })
            .catch(error => {
                console.error('Error loading rating list:', error);
                const container = document.getElementById('ratingList');
                if (container) {
                    container.innerHTML =
                        '<div class="alert alert-danger">Failed to load reviews</div>';
                }
            });
    }

    async function saveAiTrail(buttonEl) {
        const metaEl = document.getElementById('aiTrailMeta');
        const token = metaEl ? metaEl.dataset.token : null;
        if (!token) {
            alert('Unable to save this trail. Please refresh and try again.');
            return;
        }

        try {
            buttonEl.disabled = true;
            const originalText = buttonEl.innerHTML;
            buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            const response = await fetch(`/trails/ai/${token}/save`, {
                method: 'POST'
            });

            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                throw new Error('Failed to save trail');
            }

            const data = await response.json();
            if (data && data.detailUrl) {
                window.location.href = data.detailUrl;
            } else if (data.trailId) {
                window.location.href = `/trails/${data.trailId}`;
            } else {
                throw new Error('Trail saved but detail URL missing');
            }
        } catch (error) {
            console.error('Error saving AI trail:', error);
            alert('Could not save this trail. Please try again.');
            buttonEl.disabled = false;
            buttonEl.innerHTML = '<i class="fas fa-save"></i> Save to My Trails';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (isAiTrail) {
            console.log('AI-generated trail view detected. Ratings and collections disabled until saved.');
            const saveBtn = document.getElementById('saveAiTrailBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    saveAiTrail(saveBtn);
                });
            }
        }

        if (!isAiTrail) {
            // Only attach submit handler if the form exists (i.e., not in summary-only view)
            const ratingForm = document.getElementById('ratingForm');
            if (ratingForm) {
                ratingForm.addEventListener('submit', submitRating);
            }

            loadRatings();
        }
    });
</script>
</body>
</html>
